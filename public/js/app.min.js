function randomInt(a){return~~(Math.random()*a)}function toRadians(a){return a*PI_OVER_180}function toDegrees(a){return a*_180_OVER_PI}function constrain(a,b,c){return Math.min(Math.max(a,b),c)}function isLeft(a,b,c,d,e,f){return(c-a)*(f-b)-(d-b)*(e-a)>0}function angleBetween(a,b,c,d){return Math.atan2(d-b,c-a)}function distance(a,b,c,d){return(c-a)*(c-a)+(d-b)*(d-b)}function Vec2(a,b){this.x=a,this.y=b}function intersectVectors(a,b,c,d){var e=Vec2.subtract(b,a),f=Vec2.subtract(c,d);return Vec2.cross(Vec2.subtract(c,a),e)/Vec2.cross(f,e)}function generateMap(){for(var a=[40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,40,40,0,58,0,0,0,35,0,0,0,0,0,0,0,40,40,0,33,0,33,0,32,0,0,0,0,0,0,0,40,40,0,33,0,0,0,58,0,0,0,0,0,0,0,40,40,58,33,59,33,0,0,0,0,0,0,0,0,0,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,40,40,0,0,0,0,0,0,58,0,57,57,34,35,0,40,40,0,0,0,0,0,0,33,0,0,0,0,0,0,40,40,0,0,0,0,0,0,32,0,0,0,0,0,0,40,40,0,0,0,0,0,0,34,0,0,0,0,0,0,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,40,40,40,41,40,40,40,40,40,40,40,40,40,40,40,40],b=0;WORLD_STRIDE>b;b++)a[b]=randomInt(6)+40,a[b*WORLD_STRIDE]=randomInt(6)+40,a[b*WORLD_STRIDE+(WORLD_STRIDE-1)]=randomInt(6)+40,a[WORLD_STRIDE*(WORLD_STRIDE-1)+b]=randomInt(6)+40;for(var b=0;b<a.length;b++){var c=0,d=0,e=0,f=0;if(58==a[b]){c=TILE_FLAGS_TRANSPARENT|TILE_FLAGS_WALKABLE|TILE_FLAGS_VISIBLE;switch(randomInt(4)){case 0:d=TILE_FACE_S;break;case 1:d=TILE_FACE_N;break;case 2:d=TILE_FACE_E;break;case 3:d=TILE_FACE_W}e=TILE_FACE_ALL}else 57==a[b]?(c=TILE_FLAGS_TRANSPARENT|TILE_FLAGS_VISIBLE|TILE_FLAGS_WALKABLE,d=TILE_FACE_N|TILE_FACE_S,e=TILE_FACE_E|TILE_FACE_W):59==a[b]?(barsTile=b,c=TILE_FLAGS_TRANSPARENT|TILE_FLAGS_VISIBLE|TILE_FLAGS_WALKABLE,d=TILE_FACE_S,e=~d,f=d):0!=a[b]&&(c=TILE_FLAGS_VISIBLE,d=TILE_FACE_ALL,e=0);0==a[b]&&(c=TILE_FLAGS_WALKABLE,e=TILE_FACE_ALL);for(var g=b%WORLD_STRIDE,h=~~(b/WORLD_STRIDE),i=[],j=[[0,0,1,0],[1,0,1,1],[1,1,0,1],[0,1,0,0]],k=0;4>k;k++){var l=(j[k][0]+g)*GRID_SIZE,m=(j[k][1]+h)*GRID_SIZE,n=(j[k][2]+g)*GRID_SIZE,o=(j[k][3]+h)*GRID_SIZE;i.push([new Vec2(l,m),new Vec2(n,o)])}world.push({gridx:g,gridy:h,textureIndex:a[b],flags:c,walkableface:e,frontface:d,backface:d,usableface:f,faceVectors:i,texOffset:0})}for(var b=0;20>b;b++){for(var g=0,h=0,p=!1,q=(WORLD_STRIDE-2)*GRID_SIZE+GRID_SIZE;!p;)g=randomInt(q),h=randomInt(q),isWalkable(getWorld(g,h))&&(p=!0);var r=Math.floor(8*Math.random()),s=Math.floor(4*Math.random());sprites.push({x:g,y:h,tileX:r,tileY:s})}}function getWorld(a,b){var c=~~(a/GRID_SIZE),d=~~(b/GRID_SIZE);return c>=WORLD_STRIDE||d>=WORLD_STRIDE||0>c||0>d?0:c+d*WORLD_STRIDE}function intersectSides(a,b,c,d,e){for(var f=new Vec2(b,c),g=new Vec2(d,e),h=0;4>h;h++){var i=intersectVectors(a.faceVectors[h][0],a.faceVectors[h][1],f,g);if(i>=0&&1>=i)return 1<<h}return 0}function isWalkable(a){return(a&TILE_FLAGS_WALKABLE)==TILE_FLAGS_WALKABLE}function isTransparent(a){return(a&TILE_FLAGS_TRANSPARENT)==TILE_FLAGS_TRANSPARENT}function isVisible(a){return(a&TILE_FLAGS_VISIBLE)==TILE_FLAGS_VISIBLE}function use(a,b){59==a.textureIndex&&(a.isOpen=!a.isOpen)}function debugAnimateBars(a){var b=world[barsTile].isOpen?1:.05;world[barsTile].texOffset+=.15*(b-world[barsTile].texOffset),world[barsTile].texOffset>.5?world[barsTile].walkableface=TILE_FACE_ALL:world[barsTile].walkableface=TILE_FACE_ALL&~TILE_FACE_S}function drawSprite(a,b,c,d,e,f,g){var h=a*TILE_SIZE,i=b*TILE_SIZE,j=constrain(c,0,VIEWPORT_WIDTH-1),k=constrain(~~(c+f),0,VIEWPORT_WIDTH-1),l=constrain(d,0,VIEWPORT_HEIGHT-1),m=constrain(~~(d+g),0,VIEWPORT_HEIGHT-1),n=0,o=0,p=0,q=0,r=0,s=0;for(o=l;m>o;o++)for(q=~~((o-d)/g*TILE_SIZE),n=j;k>n;n++)p=~~((n-c)/f*TILE_SIZE),r=n+o*BUFFER_WIDTH,s=textureLookup32[h+p+128*(i+q)],depthBuffer[r]>e&&0!=(4278190080&s)&&(buffer32[r]=s,depthBuffer[r]=e)}function renderSprites(){for(var a=toRadians(40),b=1e3*Math.cos(playerDirection-a)+playerX,c=1e3*Math.sin(playerDirection-a)+playerY,d=1e3*Math.cos(playerDirection+a)+playerX,e=1e3*Math.sin(playerDirection+a)+playerY,f=GRID_SIZE/2-playerHeight,g=Math.cos(-playerDirection),h=Math.sin(-playerDirection),i=0;i<sprites.length;i++){var j=angleBetween(playerX,playerY,sprites[i].x,sprites[i].y),k=(24*Math.cos(j)+sprites[i].x,24*Math.sin(j)+sprites[i].y,sprites[i].x-playerX),l=sprites[i].y-playerY,m=g*k-h*l+playerX,n=h*k+g*l+playerY;if(isLeft(playerX,playerY,b,c,sprites[i].x,sprites[i].y)&&!isLeft(playerX,playerY,d,e,sprites[i].x,sprites[i].y)){j=angleBetween(playerX,playerY,m,n);var o=Math.sqrt(distance(playerX,playerY,sprites[i].x,sprites[i].y)),p=o*Math.cos(j),q=~~(f/p*distanceToProjectionPlane),r=Math.cos(-HALF_PI+j)*o,s=r/p*distanceToProjectionPlane,t=GRID_SIZE,u=t/p*distanceToProjectionPlane;u=2*~~(u/2+.5)+1;var v=~~(halfViewWidth+s-u/2),w=~~(halfViewHeight-u/2-q);drawSprite(sprites[i].tileX,sprites[i].tileY,v,w,o,u,u)}}}function drawSlice(a,b,c,d,e,f,g){var h=world[a],i=h.textureIndex%8,j=~~(h.textureIndex/8),k=0,l=b+~~(h.texOffset*TILE_SIZE),m=Math.round(Math.min(i*TILE_SIZE+l,i*TILE_SIZE+TILE_SIZE));if(!(0>l||l>=TILE_SIZE))for(var n=j*TILE_SIZE,o=m+128*n,p=0,q=e-d,r=TILE_SIZE/q,s=Math.max(0,-d),t=q/2,u=0;t>s;)k=c+(s+d)*BUFFER_WIDTH,p=~~(r*s),u=textureLookup32[o+(p<<7)],u&&(buffer32[k]=u,depthBuffer[k]=f),k=c+(e-s)*BUFFER_WIDTH,p=TILE_SIZE-1-p,u=textureLookup32[o+(p<<7)],u&&(buffer32[k]=u,depthBuffer[k]=f),s++}function castRayRecursive(a,b,c,d,e,f,g,h,i,j){var k,l,m,n,o=Math.cos(e),p=Math.sin(e),q=Math.tan(e),r={},s=c,t=d,u=!1,v=-1,w=0,x=!1,y=!1,z=0,A=0,B=0;0>p?(t=~~(d/GRID_SIZE)*GRID_SIZE,s=c-(d-t)/q,B=i?1:-1,l=-GRID_SIZE,k=-GRID_SIZE/Math.tan(e),y=i,A=i?TILE_FACE_N:TILE_FACE_S):(t=~~(d/GRID_SIZE)*GRID_SIZE+GRID_SIZE,s=c-(d-t)/q,B=i?-1:1,l=GRID_SIZE,k=GRID_SIZE/q,y=!i,A=i?TILE_FACE_S:TILE_FACE_N),w=0;for(var C;!u&&g>w&&(v=getWorld(s,t+B),C=world[v]);)!i&&isVisible(C.flags)&&v!=h||i&&v==h?u=!0:(s+=k,t+=l),w++;var D=distance(a,b,s,t),E=s,F=t,G=v,H=0;for(0>o?(s=~~(c/GRID_SIZE)*GRID_SIZE,t=d-(c-s)*q,H=i?1:-1,n=-GRID_SIZE*q,m=-GRID_SIZE,x=!i,z=i?TILE_FACE_W:TILE_FACE_E):(s=~~(c/GRID_SIZE)*GRID_SIZE+GRID_SIZE,t=d-(c-s)*q,H=i?-1:1,m=GRID_SIZE,n=GRID_SIZE*q,x=i,z=i?TILE_FACE_E:TILE_FACE_W),w=0,u=!1;!u&&g>w&&(v=getWorld(s+H,t),C=world[v]);)!i&&isVisible(C.flags)&&v!=h||i&&v==h?u=!0:(s+=m,t+=n),w++;var I=distance(a,b,s,t),J=s,K=t,L=v,M=0,C=null;I>D?(J=E,K=F,r.tileId=G,r.sampleX=(J-~~(J/GRID_SIZE)*GRID_SIZE)/GRID_SIZE,r.distance=Math.sqrt(D),C=world[r.tileId],M=A,y&&(r.sampleX=1-r.sampleX)):(r.sampleX=(K-~~(K/GRID_SIZE)*GRID_SIZE)/GRID_SIZE,r.tileId=L,r.distance=Math.sqrt(I),M=z,C=world[r.tileId],x&&(r.sampleX=1-r.sampleX)),r.transparent=isTransparent(C.flags),i?0!=(M&C.backface)&&f.push(r):r.transparent&&0==(M&C.frontface)||f.push(r),r.transparent&&!i&&(castRayRecursive(a,b,J,K,e,f,g-1,r.tileId,!0),castRayRecursive(a,b,J,K,e,f,g-1,r.tileId,!1))}function castFloor(a,b,c){for(var d,e,f,g=Math.cos(c),h=a;VIEWPORT_HEIGHT>h;h++)d=playerHeight/(h-halfViewHeight)*distanceToProjectionPlane,e=~~(d/g),f=h*BUFFER_WIDTH+b,buffer32[f]=floorColor,depthBuffer[f]=e}function castCeiling(a,b,c){for(var d,e,f,g=Math.cos(c),h=GRID_SIZE-playerHeight,i=0;a>i;i++)d=h/(halfViewHeight-i)*distanceToProjectionPlane,e=~~(d/g),f=i*BUFFER_WIDTH+b,buffer32[f]=ceilingColor,depthBuffer[f]=e}function renderWorld(){var a,b,c,d,e,f,g,h,i,j=fov/VIEWPORT_WIDTH,k=playerDirection-fov/2,l=playerDirection+fov/2,h={},m=0,n=0,o=[],p=GRID_SIZE/2-playerHeight,q=playerX,r=playerY;q-=30*Math.cos(playerDirection),r-=30*Math.sin(playerDirection);var s=getWorld(q,r),t=world[s],u=isTransparent(t.flags);for(u||(s=null),a=0;halfViewWidth>a;a++){for(o.length=0,u&&castRayRecursive(q,r,q,r,k+a*j,o,32,s,u),castRayRecursive(q,r,q,r,k+a*j,o,32),i=o.length-1;i>=0;i--)h=o[i],b=h.distance*Math.cos(-halfFov+a*j),c=GRID_SIZE/b*distanceToProjectionPlane,d=Math.round(c/2),g=~~(p/b*distanceToProjectionPlane),e=halfViewHeight-d-g,f=halfViewHeight+d-1-g,drawSlice(h.tileId,~~(h.sampleX*TILE_SIZE),a,e,f,h.distance,h),i==o.length-1&&(m=f+1,n=e,castCeiling(n,a,-halfFov+a*j),castFloor(m,a,-halfFov+a*j));for(o.length=0,u&&castRayRecursive(q,r,q,r,l-a*j,o,32,s,u),castRayRecursive(q,r,q,r,l-a*j,o,32),i=o.length-1;i>=0;i--)h=o[i],b=h.distance*Math.cos(-halfFov+a*j),c=GRID_SIZE/b*distanceToProjectionPlane,d=Math.round(c/2),g=~~(p/b*distanceToProjectionPlane),e=halfViewHeight-d-g,f=halfViewHeight+d-1-g,drawSlice(h.tileId,~~(h.sampleX*TILE_SIZE),VIEWPORT_WIDTH-a-1,e,f,h.distance,h),i==o.length-1&&(m=f+1,n=e,castCeiling(n,VIEWPORT_WIDTH-a-1,-halfFov+a*j),castFloor(m,VIEWPORT_WIDTH-a-1,-halfFov+a*j))}}function setKey(a,b){keys[a]=b}function keyDown(a){keys[a.keyCode]||(setKey(a.keyCode,!0),keyPressed(a.keyCode))}function keyPressed(a){switch(a){case KEY_W:case KEY_UP:forward();break;case KEY_S:case KEY_DOWN:backward();break;case KEY_A:straifLeft();break;case KEY_D:straifRight();break;case KEY_Q:case KEY_LEFT:turnLeft();break;case KEY_E:case KEY_RIGHT:turnRight();break;case KEY_F:action()}}function keyUp(a){setKey(a.keyCode,!1)}function playerCanMove(a,b){return Math.abs(playerX-a)<=2*GRID_SIZE&&Math.abs(playerY-b)<=2*GRID_SIZE}function action(){var a=Math.cos(playerDirection),b=Math.sin(playerDirection),c=playerX+.75*a*GRID_SIZE,d=playerY+.75*b*GRID_SIZE,e=getWorld(playerX,playerY),f=intersectSides(world[e],playerX,playerY,c,d);if(0!=(f&world[e].usableface))return void use(world[e],f);var g=getWorld(c,d),f=intersectSides(world[g],playerX,playerY,c,d);return 0!=(f&world[g].usableface)?void use(world[g],f):void 0}function tryMove(a,b,c,d){if(!playerCanMove(c,d))return!1;var e=world[getWorld(c,d)];if(isWalkable(e.flags)){var f=~~(a/GRID_SIZE),g=~~(b/GRID_SIZE),h=~~(c/GRID_SIZE),i=~~(d/GRID_SIZE),j=world[getWorld(a,b)],k=0,l=0;return h>f?(l=TILE_FACE_W,k=TILE_FACE_E):f>h&&(l=TILE_FACE_E,k=TILE_FACE_W),i>g?(l=TILE_FACE_N,k=TILE_FACE_S):g>i&&(l=TILE_FACE_S,k=TILE_FACE_N),0!=(l&e.walkableface)&&0!=(k&j.walkableface)?!0:!1}return!1}function turnRight(){targetPlayerDirection+=toRadians(90)}function turnLeft(){targetPlayerDirection-=toRadians(90)}function straifLeft(){var a=targetPlayerDirection-toRadians(90),b=targetPlayerX+Math.round(Math.cos(a))*GRID_SIZE,c=targetPlayerY+Math.round(Math.sin(a))*GRID_SIZE;tryMove(targetPlayerX,targetPlayerY,b,c)&&(targetPlayerX=b,targetPlayerY=c)}function straifRight(){var a=targetPlayerDirection+toRadians(90),b=targetPlayerX+Math.round(Math.cos(a))*GRID_SIZE,c=targetPlayerY+Math.round(Math.sin(a))*GRID_SIZE;tryMove(targetPlayerX,targetPlayerY,b,c)&&(targetPlayerX=b,targetPlayerY=c)}function forward(){var a=targetPlayerDirection,b=targetPlayerX+Math.round(Math.cos(a))*GRID_SIZE,c=targetPlayerY+Math.round(Math.sin(a))*GRID_SIZE;tryMove(targetPlayerX,targetPlayerY,b,c)&&(targetPlayerX=b,targetPlayerY=c)}function backward(){var a=targetPlayerDirection,b=targetPlayerX-Math.round(Math.cos(a))*GRID_SIZE,c=targetPlayerY-Math.round(Math.sin(a))*GRID_SIZE;tryMove(targetPlayerX,targetPlayerY,b,c)&&(targetPlayerX=b,targetPlayerY=c)}function handleTouch(a){var b=window.innerWidth/4;a.touches[0].pageY<window.innerHeight/2?a.touches[0].pageX<b?straifLeft():a.touches[0].pageX>window.innerWidth-b?straifRight():forward():a.touches[0].pageX<b?turnLeft():a.touches[0].pageX>window.innerWidth-b?turnRight():backward()}function initInputEvents(){document.addEventListener("keydown",keyDown),document.addEventListener("keyup",keyUp),document.addEventListener("touchstart",handleTouch)}function initGL(a,b,c){gl=a.getContext("experimental-webgl");var d=gl.getExtension("OES_texture_float");d&&(initShader(),bufferTexture=gl.createTexture(),depthTexture=gl.createTexture(),initViewport(b,c))}function drawGL(){gl.viewport(0,0,gl.canvas.width,gl.canvas.height),gl.drawArrays(gl.TRIANGLES,0,6)}function loadColorTexture(a){gl.bindTexture(gl.TEXTURE_2D,bufferTexture),gl.pixelStorei(gl.UNPACK_ALIGNMENT,1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,BUFFER_WIDTH,BUFFER_HEIGHT,0,gl.RGBA,gl.UNSIGNED_BYTE,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}function loadDepthTexture(a){gl.bindTexture(gl.TEXTURE_2D,depthTexture),gl.pixelStorei(gl.UNPACK_ALIGNMENT,1),gl.texImage2D(gl.TEXTURE_2D,0,gl.LUMINANCE,BUFFER_WIDTH,BUFFER_HEIGHT,0,gl.LUMINANCE,gl.FLOAT,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}function initViewport(a,b){var c=VIEWPORT_HEIGHT/BUFFER_HEIGHT,d=VIEWPORT_WIDTH/BUFFER_WIDTH,e=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),f=new Float32Array([0,c,d,c,0,0,0,0,d,c,d,0]),g=gl.getAttribLocation(shader.program,"a_position");screenGeometry.verts=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,screenGeometry.verts),gl.bufferData(gl.ARRAY_BUFFER,e,gl.STATIC_DRAW),gl.enableVertexAttribArray(g),gl.vertexAttribPointer(g,2,gl.FLOAT,!1,0,0);var h=gl.getAttribLocation(shader.program,"a_uv");screenGeometry.uvs=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,screenGeometry.uvs),gl.bufferData(gl.ARRAY_BUFFER,f,gl.STATIC_DRAW),gl.enableVertexAttribArray(h),gl.vertexAttribPointer(h,2,gl.FLOAT,!1,0,0);var i=gl.getUniformLocation(shader.program,"u_image"),j=gl.getUniformLocation(shader.program,"u_depth");gl.uniform1i(i,0),gl.uniform1i(j,1),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,bufferTexture),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,depthTexture)}function initShader(){shader.vertex=compileShader(gl,"vertex-shader",gl.VERTEX_SHADER),shader.fragment=compileShader(gl,"fragment-shader",gl.FRAGMENT_SHADER),shader.program=createProgram(gl,shader.vertex,shader.fragment),gl.useProgram(shader.program)}function createProgram(a,b,c){var d=a.createProgram();a.attachShader(d,b),a.attachShader(d,c),a.linkProgram(d);var e=a.getProgramParameter(d,a.LINK_STATUS);if(!e)throw"program filed to link:"+a.getProgramInfoLog(d);return d}function compileShader(a,b,c){var d=document.getElementById(b).textContent,e=a.createShader(c);a.shaderSource(e,d),a.compileShader(e);var f=a.getShaderParameter(e,a.COMPILE_STATUS);if(!f)throw"could not compile shader:"+a.getShaderInfoLog(e);return e}function updatePlayer(a){playerAngularVelocity+=50*(targetPlayerDirection-playerDirection)*a,playerAngularVelocity*=Math.pow(1e-6,a),playerDirection+=playerAngularVelocity*a,playerXDelta+=100*(targetPlayerX-playerX)*a,playerYDelta+=100*(targetPlayerY-playerY)*a;var b=300;playerXDelta=Math.min(Math.max(-b,playerXDelta),b),playerYDelta=Math.min(Math.max(-b,playerYDelta),b),playerXDelta*=Math.pow(1e-8,a),playerYDelta*=Math.pow(1e-8,a),playerX+=playerXDelta*a,playerY+=playerYDelta*a}function update(a){for(delta=(a-lastTime)/1e3,lastTime=a,frameAccum+=delta,frameAccum>maxFrameTime&&(frameAccum=0);frameAccum>targetFrameTime;){(new Date).getTime();updatePlayer(targetFrameTime),debugAnimateBars(a),renderWorld(),loadColorTexture(buffer8),loadDepthTexture(depthBuffer),drawGL();(new Date).getTime();frameAccum-=targetFrameTime}window.requestAnimationFrame(update)}function resizeViewport(){var a=VIEWPORT_WIDTH/VIEWPORT_HEIGHT;canvas.width=window.innerWidth,canvas.height=~~(canvas.width/a),initGL(canvas)}function initialize(){imgTexture.src="images/example1.png",generateMap();var a=VIEWPORT_WIDTH/VIEWPORT_HEIGHT;canvas.width=window.innerWidth,canvas.height=~~(canvas.width/a),initGL(canvas),initInputEvents(),window.addEventListener("resize",resizeViewport),startTime=0,update(0),console.log("Initialized.")}var PI_OVER_180=Math.PI/180,_180_OVER_PI=180/Math.PI,HALF_PI=Math.PI/2;Vec2.cross=function(a,b){return a.x*b.y-a.y*b.x},Vec2.subtract=function(a,b){return new Vec2(a.x-b.x,a.y-b.y)},Vec2.add=function(a,b){return new Vec2(a.x+b.x,a.y+b.y)},Vec2.tmp1=new Vec2(0,0),Vec2.tmp2=new Vec2(0,0),Vec2.multiplyScalar=function(a,b){var c=new Vec2;return c.copy(a),c.multiplyScalar(b),c},Vec2.prototype.copy=function(a){this.x=a.x,this.y=a.y},Vec2.prototype.add=function(a){this.x+=a.x,this.y+=a.y},Vec2.prototype.subtract=function(a){this.x-=a.x,this.y-=a.y},Vec2.prototype.lengthSq=function(){return distance(0,0,this.x,this.y)},Vec2.prototype.multiplyScalar=function(a){this.x*=a,this.y*=a};for(var WORLD_STRIDE=15,world=[],sprites=[],TILE_FLAGS_TRANSPARENT=1,TILE_FLAGS_WALKABLE=2,TILE_FLAGS_VISIBLE=4,TILE_FACE_N=1,TILE_FACE_E=2,TILE_FACE_S=4,TILE_FACE_W=8,TILE_FACE_ALL=TILE_FACE_N+TILE_FACE_E+TILE_FACE_S+TILE_FACE_W,barsTile,keys=[],i=0;180>i;i++)keys[i]=!1;for(var KEY_W=87,KEY_S=83,KEY_D=68,KEY_A=65,KEY_Q=81,KEY_E=69,KEY_F=70,KEY_UP=38,KEY_DOWN=40,KEY_LEFT=37,KEY_RIGHT=39,KEY_SPACE=32,MOVE_EPSILON=1,gl,bufferTexture,depthTexture,shader={},screenGeometry={uvs:null,verts:null},TILE_SIZE=16,GRID_SIZE=64,VIEWPORT_WIDTH=160,VIEWPORT_HEIGHT=100,bufferDimension=1;VIEWPORT_WIDTH>bufferDimension;)bufferDimension<<=1;var BUFFER_WIDTH=bufferDimension,BUFFER_HEIGHT=bufferDimension,canvas=document.getElementById("output"),imgTexture=document.getElementById("texture"),textureLookup32=new Uint32Array(16384),buffer=new ArrayBuffer(BUFFER_WIDTH*BUFFER_HEIGHT*4),buffer32=new Uint32Array(buffer),buffer8=new Uint8Array(buffer),depthBuffer=new Float32Array(BUFFER_WIDTH*BUFFER_HEIGHT),playerX=9*GRID_SIZE+GRID_SIZE/2,playerY=7*GRID_SIZE+GRID_SIZE/2,playerDirection=toRadians(90),playerAngularVelocity=0,targetPlayerDirection=toRadians(90),playerXDelta=0,playerYDelta=0,targetPlayerX=playerX,targetPlayerY=playerY,playerHeight=GRID_SIZE/2,fov=toRadians(60),halfFov=fov/2,halfViewHeight=Math.floor(VIEWPORT_HEIGHT/2),halfViewWidth=Math.floor(VIEWPORT_WIDTH/2),distanceToProjectionPlane=halfViewWidth/Math.tan(halfFov),bob=0,ceilingColor=4285546544,floorColor=4282396736,lastTime=0,delta=0,frameAccum=0,targetFrameTime=1/30,maxFrameTime=10*targetFrameTime,startTime=0;imgTexture.addEventListener("load",function(){var a=document.createElement("canvas");a.width=imgTexture.width,a.height=imgTexture.height;var b=a.getContext("2d");currentTex=imgTexture,b.clearRect(0,0,imgTexture.width,imgTexture.height),b.drawImage(currentTex,0,0);for(var c,d,e,f,g=b.getImageData(0,0,imgTexture.width,imgTexture.height).data,h=0;h<textureLookup32.length;h++)c=g[4*h],d=g[4*h+1],e=g[4*h+2],f=g[4*h+3],textureLookup32[h]=f<<24|c|d<<8|e<<16});
//# sourceMappingURL=app.min.js.map