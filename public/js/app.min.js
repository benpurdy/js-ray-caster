function getDebugColor(a){return debugColors[a%debugColors.length]}function getDebugLowerColor(a){return debugLowerColors[a%debugLowerColors.length]}function getDebugFloorColor(a){return debugFloorColors[a%debugFloorColors.length]}function randomInt(a){return~~(Math.random()*a)}function toRadians(a){return a*PI_OVER_180}function toDegrees(a){return a*_180_OVER_PI}function constrain(a,b,c){return Math.min(Math.max(a,b),c)}function isLeft(a,b,c,d,e,f){return(c-a)*(f-b)-(d-b)*(e-a)>0}function angleBetween(a,b,c,d){return Math.atan2(d-b,c-a)}function distance(a,b,c,d){return(c-a)*(c-a)+(d-b)*(d-b)}function Vec2(a,b){this.x=a,this.y=b}function intersectVectors(a,b,c,d){var e=Vec2.subtract(b,a),f=Vec2.subtract(c,d);return Vec2.cross(Vec2.subtract(c,a),e)/Vec2.cross(f,e)}function generateMap(){for(var a=[40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,58,0,0,0,0,0,0,0,0,0,0,0,0,40,40,0,58,0,0,0,35,0,0,0,0,0,0,0,40,40,58,33,0,33,0,32,0,0,0,0,0,0,0,40,40,0,33,0,0,0,58,0,0,0,57,0,0,0,40,40,58,33,59,33,0,0,0,0,0,0,0,0,0,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,40,40,0,0,0,0,0,0,0,0,0,57,0,0,0,40,40,0,0,0,0,0,0,58,0,57,0,34,35,0,40,40,0,0,0,0,0,0,33,0,0,0,0,0,0,40,40,0,0,0,0,0,0,32,0,0,0,0,0,0,40,40,0,0,0,0,0,0,34,0,0,0,0,0,0,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,40,40,40,41,40,40,40,40,40,40,40,40,40,40,40,40],b=0;WORLD_STRIDE>b;b++)a[b]=32,a[b*WORLD_STRIDE]=32,a[b*WORLD_STRIDE+(WORLD_STRIDE-1)]=randomInt(6)+40,a[WORLD_STRIDE*(WORLD_STRIDE-1)+b]=randomInt(6)+40;for(var b=0;b<a.length;b++){var c=0,d=0,e=0,f=0,g=a[b],h=randomInt(80)+60+(randomInt(80)+60<<8)+(randomInt(80)+60<<16);if(58==a[b]){c=TILE_FLAGS_TRANSPARENT|TILE_FLAGS_WALKABLE|TILE_FLAGS_VISIBLE;switch(randomInt(4)){case 0:d=TILE_FACE_S;break;case 1:d=TILE_FACE_N;break;case 2:d=TILE_FACE_E;break;case 3:d=TILE_FACE_W}e=TILE_FACE_ALL,h=12288}else 57==a[b]?(c=TILE_FLAGS_TRANSPARENT|TILE_FLAGS_VISIBLE|TILE_FLAGS_WALKABLE,d=TILE_FACE_N|TILE_FACE_S,e=TILE_FACE_E|TILE_FACE_W):59==a[b]?(barsTile=b,c=TILE_FLAGS_TRANSPARENT|TILE_FLAGS_VISIBLE|TILE_FLAGS_WALKABLE,d=TILE_FACE_S,e=~d,f=d):0!=a[b]&&(c=TILE_FLAGS_VISIBLE,d=TILE_FACE_ALL,e=0);0==a[b]&&(c=TILE_FLAGS_WALKABLE,e=TILE_FACE_ALL,g=40);for(var i=b%WORLD_STRIDE,j=~~(b/WORLD_STRIDE),k=[],l=[[0,0,1,0],[1,0,1,1],[1,1,0,1],[0,1,0,0]],m=0;4>m;m++){var n=(l[m][0]+i)*GRID_SIZE,o=(l[m][1]+j)*GRID_SIZE,p=(l[m][2]+i)*GRID_SIZE,q=(l[m][3]+j)*GRID_SIZE;k.push([new Vec2(n,o),new Vec2(p,q)])}var r=0==a[b]&&0==randomInt(3),s=r?64:39,t=0;r&&(s=40,d=0,c=TILE_FLAGS_WALKABLE,e=TILE_FACE_ALL,g=40,t=8*(randomInt(6)-3),-8>t&&(s=64)),world.push({floorcolor:h,gridx:i,gridy:j,flags:c,walkableface:e,visibleface:d,usableface:f,faceVectors:k,texOffsetX:0,texOffsetY:0,textureIndex:g,floorTexture:s,ceilingTexture:41,tileTextureOffset:getPixelIndexForTexture(g),ceilingTextureOffset:getPixelIndexForTexture(41),floorHeight:t,floorTextureOffset:getPixelIndexForTexture(s)})}for(var b=0;15>b;b++){for(var i=0,j=0,u=!1,v=(WORLD_STRIDE-3)*GRID_SIZE+GRID_SIZE;!u;)i=randomInt(v)+GRID_SIZE/2,j=randomInt(v)+GRID_SIZE/2,isWalkable(world[getWorld(i,j)].flags)&&(u=!0);var w=Math.floor(16*Math.random()),x=Math.floor(2*Math.random());sprites.push({x:i,y:j,tileX:w,tileY:x})}}function getWorld(a,b){var c=~~(~~a/GRID_SIZE),d=~~(~~b/GRID_SIZE);return c>=WORLD_STRIDE||d>=WORLD_STRIDE||0>c||0>d?-1:c+d*WORLD_STRIDE}function intersectSides(a,b,c,d,e){for(var f=new Vec2(b,c),g=new Vec2(d,e),h=0;4>h;h++){var i=intersectVectors(a.faceVectors[h][0],a.faceVectors[h][1],f,g);if(i>=0&&1>=i)return 1<<h}return 0}function isWalkable(a){return(a&TILE_FLAGS_WALKABLE)==TILE_FLAGS_WALKABLE}function isTransparent(a){return(a&TILE_FLAGS_TRANSPARENT)==TILE_FLAGS_TRANSPARENT}function isVisible(a){return(a&TILE_FLAGS_VISIBLE)==TILE_FLAGS_VISIBLE}function use(a,b){59==a.textureIndex&&(a.isOpen=!a.isOpen)}function debugAnimateBars(a){var b=world[barsTile].isOpen?.95:0;world[barsTile].isOpen?world[barsTile].texOffsetX=Math.min(b,world[barsTile].texOffsetX+.035):world[barsTile].texOffsetX=Math.max(b,world[barsTile].texOffsetX-.035),world[barsTile].texOffsetX>.8?world[barsTile].walkableface=TILE_FACE_ALL:world[barsTile].walkableface=TILE_FACE_ALL&~TILE_FACE_S}function drawSprite(a,b,c,d,e,f,g){var h=a*TILE_SIZE,i=b*TILE_SIZE,j=constrain(c,0,VIEWPORT_WIDTH-1),k=constrain(~~(c+f),0,VIEWPORT_WIDTH-1),l=constrain(d,0,VIEWPORT_HEIGHT-1),m=constrain(~~(d+g),0,VIEWPORT_HEIGHT-1),n=0,o=0,p=0,q=0,r=0,s=0;for(o=l;m>o;o++)for(q=~~((o-d)/g*TILE_SIZE),n=j;k>n;n++)p=~~((n-c)/f*TILE_SIZE),r=n+o*BUFFER_WIDTH,s=textureLookup32[h+p+(i+q)*TEXTURE_SIZE],depthBuffer[r]>e&&0!=(4278190080&s)&&(buffer32[r]=s,depthBuffer[r]=e)}function renderSprites(){for(var a=toRadians(40),b=1e3*Math.cos(playerDirection-a)+playerX,c=1e3*Math.sin(playerDirection-a)+playerY,d=1e3*Math.cos(playerDirection+a)+playerX,e=1e3*Math.sin(playerDirection+a)+playerY,f=GRID_SIZE/2-playerHeight,g=Math.cos(-playerDirection),h=Math.sin(-playerDirection),i=0;i<sprites.length;i++){var j=angleBetween(playerX,playerY,sprites[i].x,sprites[i].y),k=(24*Math.cos(j)+sprites[i].x,24*Math.sin(j)+sprites[i].y,sprites[i].x-playerX),l=sprites[i].y-playerY,m=g*k-h*l+playerX,n=h*k+g*l+playerY;if(isLeft(playerX,playerY,b,c,sprites[i].x,sprites[i].y)&&!isLeft(playerX,playerY,d,e,sprites[i].x,sprites[i].y)){j=angleBetween(playerX,playerY,m,n);var o=Math.sqrt(distance(playerX,playerY,sprites[i].x,sprites[i].y)),p=o*Math.cos(j),q=~~(f/p*distanceToProjectionPlane),r=Math.cos(-HALF_PI+j)*o,s=r/p*distanceToProjectionPlane,t=GRID_SIZE,u=t/p*distanceToProjectionPlane;u=2*~~(u/2+.5)+1;var v=~~(halfViewWidth+s-u/2),w=~~(halfViewHeight-u/2-q);drawSprite(sprites[i].tileX,sprites[i].tileY,v,w,o,u,u)}}}function drawSlice(a,b,c,d,e,f,g){var h={wallTop:0,floorStart:VIEWPORT_HEIGHT,floorStop:VIEWPORT_HEIGHT},i=world[c.tileId],j=c.sampleX+c.texOffsetX,k=GRID_SIZE,l=c.floorHeight,m=c.backFloorHeight,n=(k-l)/GRID_SIZE;k=halfViewHeight-(k-b)/e*distanceToProjectionPlane,l=halfViewHeight-(l-b)/e*distanceToProjectionPlane,m=halfViewHeight-(m-b)/e*distanceToProjectionPlane,h.floorStop=l>m?~~m:~~l,h.floorStart=l>m?~~m:~~l;var o=~~k,p=~~l,q=Math.sqrt(c.distance);sliceHeight=p-o,c.hasFace||(o=p);var r=Math.max(o,0),s=Math.min(p,VIEWPORT_HEIGHT);h.wallTop=p,c.transparent||(h.wallTop=r);var t;if(j>=0&&1>j&&(!c.isBackface&&!c.transparent||g)){var u,v=i.tileTextureOffset,w=~~(j*TILE_SIZE);for(s=Math.min(s,f);s>r;){u=1-(p-r)*n/sliceHeight,u=~~(Math.max(0,Math.min(u,1))*TILE_SIZE);t=a+~~r*BUFFER_WIDTH,textureSample=textureLookup32[v+w+512*u],0!=(4278190080&textureSample)&&(buffer32[t]=textureSample,depthBuffer[t]=q),r++}}if(!g&&!c.isBackface&&c.floorHeight>c.backFloorHeight){var x=c.floorHeight-c.backFloorHeight,y=x/GRID_SIZE;for(x=~~(x/e*distanceToProjectionPlane),r=Math.max(p-1,0),p+=x,h.floorStop=r,s=Math.min(p,VIEWPORT_HEIGHT),j=c.sampleX+c.backTexOffsetX,v=c.backTileTextureOffset,v+=~~(j*TILE_SIZE),s=Math.min(f,s),c.transparent&&(h.wallTop=r);s>r;)u=(1-(p-r)/x)*y,u=~~(Math.min(u,1)*TILE_SIZE),t=a+~~r*BUFFER_WIDTH,textureSample=textureLookup32[v+u*TEXTURE_SIZE],buffer32[t]=textureSample,depthBuffer[t]=q,r++;h.floorStart=s}return h}function getPixelIndexForTexture(a){var b=~~(a/16),c=a-16*b;return console.log(a,c,b),c*TILE_SIZE+b*TILE_SIZE*TEXTURE_SIZE}function debugClearBuffers(){var a,b,c;for(b=0;VIEWPORT_HEIGHT>b;b++)for(a=0;VIEWPORT_WIDTH>a;a++)c=a+b*BUFFER_WIDTH,buffer32[c]=16711935,depthBuffer[c]=1e11}function debugDrawDividers(){var a,b,c,d=~~(VIEWPORT_HEIGHT/2);for(b=d;b>=0;b-=16)c=~~(VIEWPORT_WIDTH/2)+b*BUFFER_WIDTH,buffer32[c]=4294967295,buffer32[c+1]=4289374890,c=~~(VIEWPORT_WIDTH/2)+(d+b-2)*BUFFER_WIDTH,buffer32[c]=4294967295,buffer32[c+1]=4289374890;for(b=~~(VIEWPORT_HEIGHT/2),a=0;VIEWPORT_WIDTH>a;a+=16)c=a+b*BUFFER_WIDTH,buffer32[c]=4294967295,buffer32[c+BUFFER_WIDTH]=4289374890}function castRayRecursive(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o=Math.cos(e),p=Math.sin(e),q=Math.tan(e),r={},s=c,t=d,u=!1,v=-1,w=0,x=!1,y=!1,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=null,I=null;for(0>p?(t=~~(d/GRID_SIZE)*GRID_SIZE,s=c+(t-d)/q,D=-.1,F=1,B=TILE_FACE_S,C=TILE_FACE_N,j=-GRID_SIZE,i=-(GRID_SIZE/q)):(t=~~(d/GRID_SIZE)*GRID_SIZE+GRID_SIZE,s=c+(t-d)/q,D=.01,F=-1,B=TILE_FACE_N,C=TILE_FACE_S,j=GRID_SIZE,i=GRID_SIZE/q,y=!0),w=0;!u&&g>w&&(v=getWorld(s,t+D),h=world[v],I=getWorld(s,t+D+GRID_SIZE*F),n=world[I],h||n);)isVisible(h.flags)||isVisible(n.flags)||h&&n&&n.floorHeight!=h.floorHeight?u=!0:(s+=i,t+=j),w++;var J=distance(a,b,s,t),K=s,L=t,M=v;for(0>o?(s=~~(c/GRID_SIZE)*GRID_SIZE,t=d+(s-c)*q,E=-.1,G=1,z=TILE_FACE_E,A=TILE_FACE_W,l=-(GRID_SIZE*q),k=-GRID_SIZE,x=!0):(s=~~(c/GRID_SIZE)*GRID_SIZE+GRID_SIZE,t=d+(s-c)*q,E=.01,G=-1,z=TILE_FACE_W,A=TILE_FACE_E,k=GRID_SIZE,l=GRID_SIZE*q),w=0,u=!1;!u&&g>w&&(v=getWorld(s+E,t),h=world[v],H=getWorld(s+E+GRID_SIZE*G,t),m=world[H],h||m);)isVisible(h.flags)||isVisible(m.flags)||h&&m&&m.floorHeight!=h.floorHeight?u=!0:(s+=k,t+=l),w++;var N,O,P=distance(a,b,s,t),Q=s,R=t,S=v,T=0,U=0,h=null,V=0,W=0,X=0;P>=J?(Q=K,R=L,V=Q,W=R+D,h=world[M],r.tileId=M,r.sampleX=Q%GRID_SIZE/GRID_SIZE,r.distance=J,r.texOffsetX=h.texOffsetX,r.hitType=1,r.isBackface=!1,T=B,U=C,N=n,O=I,y&&(r.sampleX=1-r.sampleX)):(V=Q+E,W=R,h=world[S],r.sampleX=R%GRID_SIZE/GRID_SIZE,r.tileId=S,r.distance=P,r.texOffsetX=h.texOffsetX,r.hitType=2,r.isBackface=!1,T=z,U=A,N=m,O=H,x&&(r.sampleX=1-r.sampleX));var X=h.floorHeight;if(-N.floorHeight,r.hasFace=0!=(h.visibleface&T),r.hasLower=N.floorHeight<h.floorHeight,r.lower=X,r.floorHeight=h.floorHeight,r.backFloorHeight=N.floorHeight,r.transparent=isTransparent(h.flags),r.backTileTextureOffset=N.tileTextureOffset,r.backTexOffsetX=N.texOffsetX,h||N){var Y=!1;if(N&&0!=(N.visibleface&U)){var Z={isBackface:!0,hasLower:!1,hasFace:0!=(N.visibleface&U),lower:0,upper:0,sampleX:1-r.sampleX,tileId:O,texOffsetX:N.texOffsetX,backTexOffsetX:N.texOffsetX,distance:r.distance-1,transparent:isTransparent(N.flags),floorHeight:0};f.push(Z),Y=!0}f.push(r),Y=r.transparent||!r.hasFace?!0:!1,Y&&castRayRecursive(a,b,V,W,e,f,g-1)}}function castFloor(a,b,c,d,e,f){for(var g,h,i,j,k=Math.cos(d),l=Math.cos(d+playerDirection),m=Math.sin(d+playerDirection),n=0,o=0,p=0,q=0,r=0,s=a;b>s;s++){g=(playerHeight-e)/(s+1-halfViewHeight)*distanceToProjectionPlane,h=g/k,n=h*l+offsetPlayerX,o=h*m+offsetPlayerY;getWorld(n,o);j=world[getWorld(n,o)],j&&(p=~~(n%GRID_SIZE/2),q=~~(o%GRID_SIZE/2),i=s*BUFFER_WIDTH+c,r=j.floorTextureOffset+p+q*TEXTURE_SIZE,buffer32[i]=textureLookup32[r],depthBuffer[i]=~~h)}}function castCeiling(a,b,c){for(var d,e,f,g,h,i=Math.cos(c),j=Math.cos(c+playerDirection),k=Math.sin(c+playerDirection),l=GRID_SIZE-playerHeight,m=0,n=0,o=0,p=0,q=0,r=0;a>r;r++)d=l/(halfViewHeight-r)*distanceToProjectionPlane,e=d/i,m=~~(e*j+offsetPlayerX),n=~~(e*k+offsetPlayerY),o=~~(m%GRID_SIZE/2),p=~~(n%GRID_SIZE/2),g=world[getWorld(m,n)],g&&(q=g.ceilingTextureOffset+o+p*TEXTURE_SIZE,h=textureLookup32[q],f=r*BUFFER_WIDTH+b,buffer32[f]=h,depthBuffer[f]=~~e)}function renderWorld(){var a,b,c,d,e=fov/VIEWPORT_WIDTH,f=e/2,g=playerDirection-fov/2+f,c={},h=[],i=playerHeight;offsetPlayerX=playerX,offsetPlayerY=playerY,offsetPlayerX-=30*Math.cos(playerDirection),offsetPlayerY-=30*Math.sin(playerDirection);var j;for(a=0;VIEWPORT_WIDTH>a;a++){h.length=0;var k=g+a*e;j=Math.cos(-halfFov+a*e+f),castRayRecursive(offsetPlayerX,offsetPlayerY,offsetPlayerX,offsetPlayerY,k,h,32);var l=VIEWPORT_HEIGHT,m=VIEWPORT_HEIGHT,n={floorStop:VIEWPORT_HEIGHT,wallTop:VIEWPORT_HEIGHT};for(d=0;d<h.length;d++)c=h[d],c.isBackface||(b=Math.sqrt(c.distance)*j,n=drawSlice(a,i,c,k-playerDirection,b,l,!1),c.yClip=l,n.floorStart>halfViewHeight&&castFloor(n.floorStart,l,a,k-playerDirection,c.backFloorHeight,c.tileId)),m=Math.min(n.wallTop,m),l=Math.min(Math.min(VIEWPORT_HEIGHT,n.floorStop),l),c.yClip=l;for(castCeiling(m,a,k-playerDirection),d=h.length-1;d>=0;d--)c=h[d],(c.isBackface||c.transparent)&&(b=Math.sqrt(c.distance)*j,drawSlice(a,i,c,k-playerDirection,b,c.yClip,!0))}}function setKey(a,b){keys[a]=b}function keyDown(a){keys[a.keyCode]||(setKey(a.keyCode,!0),keyPressed(a.keyCode))}function keyPressed(a){switch(a){case KEY_W:case KEY_UP:forward();break;case KEY_S:case KEY_DOWN:backward();break;case KEY_A:straifLeft();break;case KEY_D:straifRight();break;case KEY_Q:case KEY_LEFT:turnLeft();break;case KEY_E:case KEY_RIGHT:turnRight();break;case KEY_F:action()}}function keyUp(a){setKey(a.keyCode,!1)}function playerCanMove(a,b){return Math.abs(playerX-a)<=2*GRID_SIZE&&Math.abs(playerY-b)<=2*GRID_SIZE}function action(){var a=Math.cos(playerDirection),b=Math.sin(playerDirection),c=playerX+.75*a*GRID_SIZE,d=playerY+.75*b*GRID_SIZE,e=getWorld(playerX,playerY),f=intersectSides(world[e],playerX,playerY,c,d);if(0!=(f&world[e].usableface))return void use(world[e],f);var g=getWorld(c,d),f=intersectSides(world[g],playerX,playerY,c,d);return 0!=(f&world[g].usableface)?void use(world[g],f):void 0}function tryMove(a,b,c,d){if(!playerCanMove(c,d))return!1;var e=world[getWorld(c,d)];if(isWalkable(e.flags)){var f=~~(a/GRID_SIZE),g=~~(b/GRID_SIZE),h=~~(c/GRID_SIZE),i=~~(d/GRID_SIZE),j=world[getWorld(a,b)],k=0,l=0;return h>f?(l=TILE_FACE_W,k=TILE_FACE_E):f>h&&(l=TILE_FACE_E,k=TILE_FACE_W),i>g?(l=TILE_FACE_N,k=TILE_FACE_S):g>i&&(l=TILE_FACE_S,k=TILE_FACE_N),0!=(l&e.walkableface)&&0!=(k&j.walkableface)?!0:!1}return!1}function turnRight(){targetPlayerDirection+=toRadians(90)}function turnLeft(){targetPlayerDirection-=toRadians(90)}function straifLeft(){var a=targetPlayerDirection-toRadians(90),b=targetPlayerX+Math.round(Math.cos(a))*GRID_SIZE,c=targetPlayerY+Math.round(Math.sin(a))*GRID_SIZE;tryMove(targetPlayerX,targetPlayerY,b,c)&&(targetPlayerX=b,targetPlayerY=c)}function straifRight(){var a=targetPlayerDirection+toRadians(90),b=targetPlayerX+Math.round(Math.cos(a))*GRID_SIZE,c=targetPlayerY+Math.round(Math.sin(a))*GRID_SIZE;tryMove(targetPlayerX,targetPlayerY,b,c)&&(targetPlayerX=b,targetPlayerY=c)}function forward(){var a=targetPlayerDirection,b=targetPlayerX+Math.round(Math.cos(a))*GRID_SIZE,c=targetPlayerY+Math.round(Math.sin(a))*GRID_SIZE;tryMove(targetPlayerX,targetPlayerY,b,c)?(targetPlayerX=b,targetPlayerY=c):action()}function backward(){var a=targetPlayerDirection,b=targetPlayerX-Math.round(Math.cos(a))*GRID_SIZE,c=targetPlayerY-Math.round(Math.sin(a))*GRID_SIZE;tryMove(targetPlayerX,targetPlayerY,b,c)&&(targetPlayerX=b,targetPlayerY=c)}function handleTouch(a){var b=window.innerWidth/4;a.touches[0].pageY<window.innerHeight/2?a.touches[0].pageX<b?straifLeft():a.touches[0].pageX>window.innerWidth-b?straifRight():forward():a.touches[0].pageX<b?turnLeft():a.touches[0].pageX>window.innerWidth-b?turnRight():backward()}function initInputEvents(){document.addEventListener("keydown",keyDown),document.addEventListener("keyup",keyUp),document.addEventListener("touchstart",handleTouch)}function initGL(a,b,c){gl=a.getContext("experimental-webgl");var d=gl.getExtension("OES_texture_float");d&&(initShader(),bufferTexture=gl.createTexture(),depthTexture=gl.createTexture(),initViewport(b,c))}function drawGL(){gl.viewport(0,0,gl.canvas.width,gl.canvas.height),gl.drawArrays(gl.TRIANGLES,0,6)}function loadColorTexture(a){gl.bindTexture(gl.TEXTURE_2D,bufferTexture),gl.pixelStorei(gl.UNPACK_ALIGNMENT,1),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,BUFFER_WIDTH,BUFFER_HEIGHT,0,gl.RGBA,gl.UNSIGNED_BYTE,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}function loadDepthTexture(a){gl.bindTexture(gl.TEXTURE_2D,depthTexture),gl.pixelStorei(gl.UNPACK_ALIGNMENT,1),gl.texImage2D(gl.TEXTURE_2D,0,gl.LUMINANCE,BUFFER_WIDTH,BUFFER_HEIGHT,0,gl.LUMINANCE,gl.FLOAT,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}function initViewport(a,b){var c=VIEWPORT_HEIGHT/BUFFER_HEIGHT,d=VIEWPORT_WIDTH/BUFFER_WIDTH,e=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),f=new Float32Array([0,c,d,c,0,0,0,0,d,c,d,0]),g=gl.getAttribLocation(shader.program,"a_position");screenGeometry.verts=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,screenGeometry.verts),gl.bufferData(gl.ARRAY_BUFFER,e,gl.STATIC_DRAW),gl.enableVertexAttribArray(g),gl.vertexAttribPointer(g,2,gl.FLOAT,!1,0,0);var h=gl.getAttribLocation(shader.program,"a_uv");screenGeometry.uvs=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,screenGeometry.uvs),gl.bufferData(gl.ARRAY_BUFFER,f,gl.STATIC_DRAW),gl.enableVertexAttribArray(h),gl.vertexAttribPointer(h,2,gl.FLOAT,!1,0,0);var i=gl.getUniformLocation(shader.program,"u_image"),j=gl.getUniformLocation(shader.program,"u_depth");gl.uniform1i(i,0),gl.uniform1i(j,1),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,bufferTexture),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,depthTexture)}function initShader(){shader.vertex=compileShader(gl,"vertex-shader",gl.VERTEX_SHADER),shader.fragment=compileShader(gl,"fragment-shader",gl.FRAGMENT_SHADER),shader.program=createProgram(gl,shader.vertex,shader.fragment),gl.useProgram(shader.program)}function createProgram(a,b,c){var d=a.createProgram();a.attachShader(d,b),a.attachShader(d,c),a.linkProgram(d);var e=a.getProgramParameter(d,a.LINK_STATUS);if(!e)throw"program filed to link:"+a.getProgramInfoLog(d);return d}function compileShader(a,b,c){var d=document.getElementById(b).textContent,e=a.createShader(c);a.shaderSource(e,d),a.compileShader(e);var f=a.getShaderParameter(e,a.COMPILE_STATUS);if(!f)throw"could not compile shader:"+a.getShaderInfoLog(e);return e}function updatePlayer(a){playerAngularVelocity+=50*(targetPlayerDirection-playerDirection)*a,playerAngularVelocity*=Math.pow(1e-6,a),playerDirection+=playerAngularVelocity*a,playerXDelta+=100*(targetPlayerX-playerX)*a,playerYDelta+=100*(targetPlayerY-playerY)*a;var b=300;playerXDelta=Math.min(Math.max(-b,playerXDelta),b),playerYDelta=Math.min(Math.max(-b,playerYDelta),b),playerXDelta*=Math.pow(1e-8,a),playerYDelta*=Math.pow(1e-8,a),playerX+=playerXDelta*a,playerY+=playerYDelta*a;var c=getWorld(playerX,playerY);playerHeight+=.23*(32+world[c].floorHeight-playerHeight)}function update(a){for(delta=(a-lastTime)/1e3,lastTime=a,frameAccum+=delta,frameAccum>maxFrameTime&&(frameAccum=0);frameAccum>targetFrameTime;){(new Date).getTime();updatePlayer(targetFrameTime),debugAnimateBars(a),renderWorld(),renderSprites(),loadColorTexture(buffer8),loadDepthTexture(depthBuffer),drawGL();(new Date).getTime();frameAccum-=targetFrameTime}window.requestAnimationFrame(update)}function resizeViewport(){var a=VIEWPORT_WIDTH/VIEWPORT_HEIGHT;canvas.width=window.innerWidth,canvas.height=~~(canvas.width/a),initGL(canvas)}function initialize(){imgTexture.src="images/32tile.png",generateMap(),resizeViewport(),initInputEvents(),window.addEventListener("resize",resizeViewport),startTime=0,update(0),console.log("Initialized.")}var debugColors=[10485760,3145728],debugFloorColors=[12632256,10485920],debugLowerColors=[40960,20480],PI_OVER_180=Math.PI/180,_180_OVER_PI=180/Math.PI,HALF_PI=Math.PI/2;Vec2.cross=function(a,b){return a.x*b.y-a.y*b.x},Vec2.subtract=function(a,b){return new Vec2(a.x-b.x,a.y-b.y)},Vec2.add=function(a,b){return new Vec2(a.x+b.x,a.y+b.y)},Vec2.tmp1=new Vec2(0,0),Vec2.tmp2=new Vec2(0,0),Vec2.multiplyScalar=function(a,b){var c=new Vec2;return c.copy(a),c.multiplyScalar(b),c},Vec2.prototype.copy=function(a){this.x=a.x,this.y=a.y},Vec2.prototype.add=function(a){this.x+=a.x,this.y+=a.y},Vec2.prototype.subtract=function(a){this.x-=a.x,this.y-=a.y},Vec2.prototype.lengthSq=function(){return distance(0,0,this.x,this.y)},Vec2.prototype.multiplyScalar=function(a){this.x*=a,this.y*=a};for(var WORLD_STRIDE=15,world=[],sprites=[],TILE_FLAGS_TRANSPARENT=1,TILE_FLAGS_WALKABLE=2,TILE_FLAGS_VISIBLE=4,TILE_FACE_N=1,TILE_FACE_E=2,TILE_FACE_S=4,TILE_FACE_W=8,TILE_FACE_ALL=TILE_FACE_N+TILE_FACE_E+TILE_FACE_S+TILE_FACE_W,barsTile,offsetPlayerX,offsetPlayerY,keys=[],i=0;180>i;i++)keys[i]=!1;for(var KEY_W=87,KEY_S=83,KEY_D=68,KEY_A=65,KEY_Q=81,KEY_E=69,KEY_F=70,KEY_UP=38,KEY_DOWN=40,KEY_LEFT=37,KEY_RIGHT=39,KEY_SPACE=32,MOVE_EPSILON=1,gl,bufferTexture,depthTexture,shader={},screenGeometry={uvs:null,verts:null},TEXTURE_SIZE=512,TILE_SIZE=32,GRID_SIZE=64,VIEWPORT_WIDTH=160,VIEWPORT_HEIGHT=100,bufferDimension=1;VIEWPORT_WIDTH>bufferDimension;)bufferDimension<<=1;var BUFFER_WIDTH=bufferDimension,BUFFER_HEIGHT=bufferDimension,canvas=document.getElementById("output"),imgTexture=document.getElementById("texture"),textureLookup32=new Uint32Array(TEXTURE_SIZE*TEXTURE_SIZE),buffer=new ArrayBuffer(BUFFER_WIDTH*BUFFER_HEIGHT*4),buffer32=new Uint32Array(buffer),buffer8=new Uint8Array(buffer),depthBuffer=new Float32Array(BUFFER_WIDTH*BUFFER_HEIGHT),playerX=9*GRID_SIZE+GRID_SIZE/2,playerY=7*GRID_SIZE+GRID_SIZE/2,playerDirection=toRadians(90),playerAngularVelocity=0,targetPlayerDirection=toRadians(90),playerXDelta=0,playerYDelta=0,targetPlayerX=playerX,targetPlayerY=playerY,playerHeight=GRID_SIZE/2,fov=toRadians(60),halfFov=fov/2,halfViewHeight=Math.floor(VIEWPORT_HEIGHT/2),halfViewWidth=Math.floor(VIEWPORT_WIDTH/2),distanceToProjectionPlane=halfViewWidth/Math.tan(halfFov),bob=0,ceilingColor=4285546544,floorColor=4282396736,lastTime=0,delta=0,frameAccum=0,targetFrameTime=1/30,maxFrameTime=10*targetFrameTime,startTime=0;imgTexture.addEventListener("load",function(){var a=document.createElement("canvas");a.width=imgTexture.width,a.height=imgTexture.height;var b=a.getContext("2d");currentTex=imgTexture,console.log("Texture loaded: ",imgTexture.width,imgTexture.height),b.clearRect(0,0,imgTexture.width,imgTexture.height),b.drawImage(currentTex,0,0);for(var c,d,e,f,g=b.getImageData(0,0,imgTexture.width,imgTexture.height).data,h=0;h<textureLookup32.length;h++)c=g[4*h],d=g[4*h+1],e=g[4*h+2],f=g[4*h+3],textureLookup32[h]=f<<24|c|d<<8|e<<16});
//# sourceMappingURL=app.min.js.map